<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Java并发(四)：locksupport</title>
    <meta name="description" content="关键词：LockSupport前面我们讨论了sun.misc.Unsafe类，该类提供了面向操作系统直接操作内存和CPU的方法，例如分配内心和阻塞线程等等。但是该类在使用时是不安全的，所以jdk在不同的场景下对它做了不同的包装。java.util.concurrent.locks.LockSupport类就是对s...">

    <link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="stylesheet" href=" /css/fontawesome/css/font-awesome.min.css ">
    <link rel="stylesheet" href=" /css/main.css ">
    <link rel="canonical" href="http://leocook.github.io/2017/07/08/Java%E5%B9%B6%E5%8F%91(%E5%9B%9B)-LockSupport/">
    <link rel="alternate" type="application/rss+xml" title="leocook" href="http://leocook.github.io /feed.xml ">


    <script>
    // 百度统计代码
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?f1ad6f37c7565a0fbaf172ac83132650";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>


<script type='text/javascript'>
      var _vds = _vds || [];
      window._vds = _vds;
      (function(){
        _vds.push(['setAccountId', 'b628e9072406c903']);
        (function() {
          var vds = document.createElement('script');
          vds.type='text/javascript';
          vds.async = true;
          vds.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'dn-growing.qbox.me/vds.js';
          var s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(vds, s);
        })();
      })();
  </script>
</head>


  <body>

    <header>
    <div class="wrapper">
        <a href="/" class="brand">leocook</a>
        <small>Big-Data Dev Engineer</small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/">
                    
                        <i class="fa fa-home"></i>Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>Archives
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>Categories
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tag/">
                        
                            <i class="fa fa-tags"></i>Tags
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/collection/">
                        
                            <i class="fa fa-bookmark"></i>Collections
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/about/">
                        
                            <i class="fa fa-heart"></i>About
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
    <script type='text/javascript'>
      var _vds = _vds || [];
      window._vds = _vds;
      (function(){
        _vds.push(['setAccountId', 'b628e9072406c903']);
        (function() {
          var vds = document.createElement('script');
          vds.type='text/javascript';
          vds.async = true;
          vds.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'dn-growing.qbox.me/vds.js';
          var s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(vds, s);
        })();
      })();
  </script>
</header>


        <div class="page clearfix" post>
    <div class="left">
        <h1>Java并发(四)：locksupport</h1>
        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i>2017-07-08
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#java" title="Category: java" rel="category">java</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

            <div class="label-card">
            
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <!--a href="/tag/#LockSupport" title="Tag: LockSupport" rel="tag">LockSupport</a-->
        <a href="/tag/#LockSupport" title="Tag: LockSupport" rel="tag">LockSupport</a>
    
  

</span>

            </div>

        </div>
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <ul id="markdown-toc">
  <li><a href="#locksupport" id="markdown-toc-locksupport">LockSupport类的核心字段</a></li>
  <li><a href="#locksupport-1" id="markdown-toc-locksupport-1">LockSupport类的核心方法</a></li>
  <li><a href="#threadinterrupt" id="markdown-toc-threadinterrupt">Thread.interrupt()方法</a></li>
  <li><a href="#section" id="markdown-toc-section">总结</a></li>
</ul>

<p>关键词：LockSupport</p>

<p>前面我们讨论了<code>sun.misc.Unsafe</code>类，该类提供了面向操作系统直接操作内存和CPU的方法，例如分配内心和阻塞线程等等。但是该类在使用时是不安全的，所以jdk在不同的场景下对它做了不同的包装。</p>

<p><code>java.util.concurrent.locks.LockSupport</code>类就是对<code>sun.misc.Unsafe</code>类进行了一些封装，主要提供一些锁的基础操作。</p>

<p>LockSupport阻塞线程的机制与<code>Object</code>的wait和notify是不一样的：</p>

<ul>
  <li>调用API层面的区别<br />
<code>LockSupport</code>的park和unpark可以用“线程”作为该方法的参数，语义更合乎逻辑。
<code>Object</code>的wait和notify是由<code>监视器对象</code>来调用的，对线程来说，它的阻塞和唤醒是被动的，不能准确的控制某个指定的线程，要么随机唤醒（notify）、要么唤醒全部（notifyAll）。</li>
  <li>实现原理的区别<br />
<code>Object</code>的wait和notify以及<code>synchronized</code>都是通过占用和释放该<code>对象的监视器</code>来实现锁的获取和释放。
<code>LockSupport</code>不使用对象的监视器，每次执行<code>park</code>时会消耗1个<code>许可</code>，每次执行<code>unpark</code>时会获得1个<code>许可</code>。</li>
</ul>

<blockquote>
  <p>如果查看Unsafe的C++<a href="http://hg.openjdk.java.net/jdk7/jdk7/hotspot/file/81d815b05abb/src/os/linux/vm/os_linux.cpp">源码</a>会发现，这个<code>许可</code>，其实就是一个<code>_counter</code>变量。
当执行<code>park</code>的时候，若<code>_counter</code>值大于0则立马返回并把<code>_counter</code>的值设置为0，线程不会阻塞；若<code>_counter</code>值等于0，则阻塞当前线程。可以理解这个过程将会消耗一个许可，若没有许可被消耗，则阻塞。
当执行<code>unpark</code>的时候，将会把<code>_counter</code>的值设置为1。可以理解这个过程是是给线程添加一个许可，且多次调用也只会添加一个许可。
<code>_counter</code>为1的时候表示许可可用，为0的时候表示许可不可用。如果能够很好的理解这个“许可”的设计，在查看LockSupport类源码的时候，将会轻松很多。</p>
</blockquote>

<h4 id="locksupport">LockSupport类的核心字段</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>//unsafe，用于CAS操作
private static final Unsafe unsafe = Unsafe.getUnsafe();

//Thread中parkBlocker的内存偏移量
private static final long parkBlockerOffset;
</code></pre>
</div>

<p>在<code>java.lang.Thread</code>类中有个字段<code>parkBlocker</code>用来存放该线程阻塞时是被哪个对象阻塞的。</p>

<h4 id="locksupport-1">LockSupport类的核心方法</h4>

<ul>
  <li>
    <p>public static void park()<br />
如果许可可用，则使用该许可，并立刻返回；否则阻塞当前线程。</p>
  </li>
  <li>
    <p>public static void park(Object blocker)<br />
如果许可可用，则使用该许可，并立刻返回；否则阻塞当前线程，并告诉线程是谁阻塞了它。</p>
  </li>
  <li>
    <p>public static void parkNanos(long nanos)<br />
如果许可可用，则使用该许可，并立刻返回；否则阻塞当前线程nanos纳秒。</p>
  </li>
  <li>
    <p>public static void parkNanos(Object blocker, long nanos)<br />
如果许可可用，则使用该许可，并立刻返回；否则阻塞当前线程nanos纳秒，并告诉线程是谁阻塞了它。</p>
  </li>
  <li>
    <p>public static void parkUntil(long deadline)<br />
如果许可可用，则使用该许可，并立刻返回；否则阻塞当前线程直到时间deadline。与parkNanos相比，这里的时间是绝对时间戳。</p>
  </li>
  <li>
    <p>public static void parkUntil(Object blocker, long deadline)<br />
如果许可可用，则使用该许可，并立刻返回；否则阻塞当前线程直到时间deadline，并告诉线程是谁阻塞了它。</p>
  </li>
  <li>
    <p>public static void unpark(Thread thread)<br />
若许可不可用，则使许可可用。若线程因为调用了park而阻塞，则它将解除阻塞状态。否则保证下一次调用park不会受阻。</p>
  </li>
  <li>
    <p>private static void setBlocker(Thread t, Object arg)<br />
给线程t设置阻塞对象，告诉t是谁阻塞了它。</p>
  </li>
  <li>
    <p>public static Object getBlocker(Thread t)<br />
获取是谁阻塞了线程t</p>
  </li>
</ul>

<h4 id="threadinterrupt">Thread.interrupt()方法</h4>

<p>Thread.interrupt()方法不会中断一个正在运行的线程。当线程被Object.wait、Thread.join和Thread.sleep三种方法阻塞时，若调用了Thread.interrupt()方法，线程将退出阻塞状态，并会抛出一个<code>InterruptedException</code>中断异常。</p>

<blockquote>
  <p><code>LockSupport.park()</code>也能够响应中断信号，但是它不会抛出<code>InterruptedException</code>中断异常。</p>
</blockquote>

<ul>
  <li>Thread.interrupted() &amp; Thread.isInterrupted()方法<br />
测试线程是否已经中断。前者是静态方法，后者不是。当我们需要停止一个线程的时候，一般有两种方式：
    <ul>
      <li>通过共享变量；</li>
      <li>通过调用线程的<code>interrupt</code>方法。</li>
    </ul>
  </li>
</ul>

<p>前者在线程阻塞的时候不能够被中断，只有当线程执行的时候才可以;而后者只能在线程处于阻塞的时候才能够被中断，线程执行时不可以中断。</p>

<ul>
  <li>interrupted status<br />
<code>interrupted status</code>是线程的中断状态，被JVM的C++代码维护着。
    <ul>
      <li>在调用Thread.join和Thread.sleep之后，将会设置interrupted status；</li>
      <li>当退出阻塞、抛出<code>InterruptedException</code>异常的时候，interrupted status将会被清除；</li>
      <li>调用<code>public static boolean interrupted()</code>方法后，会清除interrupted status</li>
    </ul>
  </li>
</ul>

<h4 id="section">总结</h4>

<p><code>java.util.concurrent.locks.LockSupport</code>类是对<code>sun.misc.Unsafe</code>类的二次封装，主要提供了一些线程阻塞的工具。
该类在AQS中被大量的运用，在阅读AQS的源码时，需要对该类有所了解。</p>

        </article>

        
        <hr>
        
        
            
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
        
        


        <h2 id="comments">订阅号</h2>
        <img src="http://7xriy2.com1.z0.glb.clouddn.com/leocook.jpg" /><br />


        <h2 id="comments">Comments</h2>
        


<div id="disqus_thread"></div>
<script>
    /**
     * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */

    var disqus_config = function() {
        this.page.url = 'http://leocook.github.io/2017/07/08/Java%E5%B9%B6%E5%8F%91(%E5%9B%9B)-LockSupport/'; // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://leocook.github.io/2017/07/08/Java%E5%B9%B6%E5%8F%91(%E5%9B%9B)-LockSupport/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };

    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document,
            s = d.createElement('script');

        s.src = '//leocook.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>




    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    Content
                </div>
                <ul id="content-side" class="content-ul">
                    <li><a href="#similar_posts">Similar Posts</a></li>
                    <li><a href="#comments">Comments</a></li>
                </ul>
            </div>
            <!-- 其他div框放到这里 -->
            <!-- <div class="side">bbbb</div> -->
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/scroll.min.js " charset="utf-8"></script>
<script src="/js/pageContent.js " charset="utf-8"></script>


    <footer class="site-footer">


  <div class="wrapper">
      <p class="description">
          
          小鸟的成长记录.
          
      </p>
        <p class="contact">
            Contact me at:
            
            <a href="https://github.com/leocook"><i class="fa fa-github" aria-hidden="true"></i></a>
            

            
            <a href="mailto:leocook@163.com"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>
            

            
            <a href="http://weibo.com/wulinjq"><i class="fa fa-weibo" aria-hidden="true"></i></a>
            

            

            

            
        </p>
        <p class="power">
            <span>
                Site powered by <a href="https://jekyllrb.com/">Jekyll</a> & <a href="https://pages.github.com/">Github Pages</a>.
            </span>
            <span>
                Theme designed by <a href="https://github.com/Gaohaoyang">HyG</a>.
            </span>
        </p>

  </div>
</footer>
<script src="/js/main.js " charset="utf-8"></script>


  </body>

</html>
